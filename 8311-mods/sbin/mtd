#!/bin/sh
# 8311 firmware update guard - mtd wrapper
#
# Replaces the stock /sbin/mtd binary to intercept OMCI-triggered firmware
# writes. When the OLT pushes a firmware image via OMCI Software Download,
# omcid downloads it to /tmp/image[01].img and then calls `mtd write` to
# flash it. This wrapper detects those specific image paths and blocks the
# write when the guard is enabled, preventing the ISP from overwriting
# custom firmware. All other mtd operations (erase, unlock, etc.) pass
# through transparently.
#
# The original mtd binary is preserved at /sbin/mtd.real.
#
# Works in tandem with:
#   /usr/sbin/fw_setenv    — shadows committed_image, captures image versions
#   /usr/sbin/fw_printenv  — returns shadow values to omcid
#
# Enable:  uci set 8311.config.fw_update_guard=1; uci commit 8311
# Disable: uci set 8311.config.fw_update_guard=0; uci commit 8311
# Bypass:  /sbin/mtd.real [args]

# Translate common PCRE shorthand classes to POSIX ERE equivalents.
# Handles \d, \D, \w, \W, \s, \S, and (?:...) non-capturing groups.
# Called only when grep -P (PCRE) is not available.
_pcre_to_ere() {
	printf '%s' "$1" | sed \
		-e 's/\\d/[0-9]/g' \
		-e 's/\\D/[^0-9]/g' \
		-e 's/\\w/[a-zA-Z0-9_]/g' \
		-e 's/\\W/[^a-zA-Z0-9_]/g' \
		-e 's/\\s/[[:space:]]/g' \
		-e 's/\\S/[^[:space:]]/g' \
		-e 's/(?:/(/g'
}

# Firmware version extraction (fw_match_b64 feature).
# If a regex pattern is configured, extract the firmware version from the
# image file and update sw_verA/sw_verB in UCI + fwenv.
# Patterns are auto-translated from PCRE shorthand (\d, \w, \s, etc.) to
# POSIX ERE equivalents for grep -E (busybox has no PCRE support).
_extract_fw_version() {
	local img="$1"
	local bank="$2"
	local fw_match
	local fw_match_num
	local version

	fw_match=$(uci -q get 8311.config.fw_match_b64)
	[ -z "$fw_match" ] && return

	fw_match_num=$(uci -q get 8311.config.fw_match_num)
	fw_match_num=${fw_match_num:-1}

	fw_match=$(_pcre_to_ere "$fw_match")
	version=$(strings "$img" 2>/dev/null | grep -E -o "$fw_match" | sed -n "${fw_match_num}p")

	if [ -n "$version" ]; then
		logger -t 8311-fw-match "Extracted firmware version from bank $bank: $version"
		if [ "$bank" = "0" ]; then
			uci set 8311.config.sw_verA="$version"
			/opt/lantiq/bin/fw_setenv image0_version "$version"
		else
			uci set 8311.config.sw_verB="$version"
			/opt/lantiq/bin/fw_setenv image1_version "$version"
		fi
		uci commit 8311
	else
		logger -t 8311-fw-match "No version match found in firmware image"
	fi
}

# Version extraction runs FIRST — must happen while the image is still in
# /tmp, regardless of whether the guard blocks or allows the flash.
for arg in "$@"; do
	case "$arg" in
		/tmp/image0.img)
			_extract_fw_version "$arg" 0
			;;
		/tmp/image1.img)
			_extract_fw_version "$arg" 1
			;;
	esac
done

# Guard check: block OMCI firmware writes when enabled.
# Exit 0 so omcid thinks the write succeeded.
for arg in "$@"; do
	case "$arg" in
		/tmp/image0.img|/tmp/image1.img)
			if [ "$(uci -q get 8311.config.fw_update_guard)" = "1" ]; then
				logger -t 8311-fw-guard "Blocked OMCI firmware write: mtd $*"
				exit 0
			fi
			;;
	esac
done

# No guarded path found (or guard disabled) -- pass through to the real mtd
exec /sbin/mtd.real "$@"
